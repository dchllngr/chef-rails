<% if @ssl %>
    if ($http_host !~ ^<%= Array(@server_name).join('|') %>){
      rewrite ^ http://$http_host$request_uri permanent;
    }

    ssl on;
    ssl_certificate <%= @ssl['certificate'] %>;
    ssl_certificate_key <%= @ssl['certificate_key'] %>;
    <% if @ssl['ca'] %>ssl_trusted_certificate <%= @ssl['ca'] %>;<% end %>

    <% if node['rails']['nginx']['hsts'] %>
      <% node['rails']['nginx']['hsts_configs'].each do |k, v| %>
        <%= k %> <%= v %>;
      <% end %>
    <% end %>

    <% node['rails']['nginx']['ssl_extra_configs'].each do |k, v| %>
      <%= k %> <%= v %>;
    <% end %>

    <% if node['rails']['nginx']['stapling'] %>
      <% node['rails']['nginx']['stapling_configs'].each do |k, v| %>
        <%= k %> <%= v %>;
      <% end %>
    <% end -%>
  <% end -%>
